#!/usr/bin/perl
use Data::Dumper;
# Get the real base directory for this script
my $basedir = "./";
if((readlink $ENV{'SCRIPT_FILENAME'} || $0) =~ /^(.*\/)[^\/]*/){ $basedir = $1; }
require "./".$basedir."lib.pl";


# Read in the configuration JSON file
$conf = loadConf($basedir."conf.json");

# Step up a directory
$basedir = "../".$basedir;




# Read in the user-set areas
%areas;
if(!-e $basedir.$conf->{'areas'}{'file'}){
	print "WARNING: The area file doesn't exist ($basedir$conf->{'areas'}{'file'}). It should be a TSV file with the ONS code in the first column and the name in the second column.\n";
	exit;
}
open(FILE,$basedir.$conf->{'areas'}{'file'});
@lines = <FILE>;
for($i = 1; $i < @lines; $i++){
	$lines[$i] =~ s/[\n\r]+//g;
	@cols = split(/\t/,$lines[$i]);
	$areas{$cols[0]} = $cols[1];
}
close(FILE);




# Download the House of Commons Library MSOA name lookup
if(!-e $basedir.$conf->{'lookup'}{'names'}){
	print "Downloading MSOA names file to $basedir$conf->{'lookup'}{'names'}\n";
	`curl -o "$basedir$conf->{'lookup'}{'names'}" $conf->{'lookup'}{'namesurl'}`;
}

# Load in the House of Commons Library MSOA name lookup
print "Reading MSOA name lookup\n";
open(FILE,$basedir.$conf->{'lookup'}{'names'});
while(<FILE>){
	#msoa11cd,msoa11nm,msoa11nmw,msoa11hclnm,msoa11hclnmw,Laname
	#E02006534,Adur 001,Adur 001,Hillside,,Adur
	$line = $_;
	if($line){
		$line =~ s/[\n\r]+//g;
		($msoa11cd,$msoa11nm,$msoa11nmw,$msoa11hclnm,$msoa11hclnmw,$Laname) = split(/,/,$line);
		if($msoa11cd !~ /msoa11cd/ && $msoa11hclnm){
			$msoa11hclnm =~ s/(^\"|\"$)//g;
			$msoa{$msoa11cd} = {'name'=>$msoa11hclnm};
		}
	}
}
close(FILE);





%lookup;
open(FILE,$basedir.$conf->{'lookup'}{'file'});
@lines = <FILE>;
for($i = 0; $i < @lines; $i++){
	$lines[$i] =~ s/[\n\r]+//g;
	#MSOA11CD	MSOA11NM	MSOA11HCLNM	LAD21CD	LAD21NM	CAUTH21CD	CAUTH21NM	Area
	#E02000001	City of London 001	City of London	E09000001	City of London			46155312.6057659
	@cols = split(/\t/,$lines[$i]);
	#print "$cols[0]\t$cols[2]\n";
	if($i == 0){
		@header = @cols;
	}else{

		$msoa11cd = $cols[0];

		if($msoa11cd){

			for($c = 1; $c < @header; $c++){
				if($header[$c] =~ /CD$/){
					if($areas{$cols[$c]}){
						if(!$lookup{$cols[$c]}){
							$lookup{$cols[$c]} = {'msoas'=>{},'name'=>$cols[$c+1]};
						}
						if(!$lookup{$cols[$c]}{'msoas'}{$msoa11cd}){ $lookup{$cols[$c]}{'msoas'}{$msoa11cd} = 0; }
						$lookup{$cols[$c]}{'msoas'}{$msoa11cd}++;
					}
				}
			}
		}

	}
}
close(FILE);




# Create the area to MSOA lookup
print "Saving area lookup to $basedir$conf->{'lookup'}{'area'}\n";
open(LOOKUP,">",$basedir.$conf->{'lookup'}{'area'});
print LOOKUP "Area\tArea name\tMSOAs\n";
foreach $l (sort(keys(%lookup))){
	print LOOKUP "$l\t$lookup{$l}{'name'}\t";
	print LOOKUP join(";",sort(keys(%{$lookup{$l}{'msoas'}})));
	print LOOKUP "\n";
}
close(LOOKUP);




# Create the GeoJSON files for each area
foreach $a (sort(keys(%areas))){
	
	if(!$lookup{$a}){
		print "WARNING: The area $a doesn't appear in the lookup.\n";
	}else{

		print "$a:\n";

		# Step 1: Make the directory if it doesn't already exist
		$adir = $basedir.$conf->{'areas'}{'dir'}.$a."/";
		if(!-d $adir){
			print "\tMaking directory $adir\n";
			`mkdir $adir`;
		}


		# Step 2: Store MSOA lookup for this area
		print "\tSaving MSOA lookup to $adir$a-msoas.tsv\n";
		open(LOOKUP,">",$adir."$a-msoas.tsv");
		@msoas = sort(keys(%{$lookup{$a}{'msoas'}}));
		for($m = 0; $m < @msoas; $m++){
			print LOOKUP "$msoas[$m]\t$msoa{$msoas[$m]}{'name'}\n";
		}
		close(LOOKUP);



		# Step 3: Create the GeoJSON
		$gfile = $basedir.$conf->{'areas'}{'dir'}."$a/$a.geojson";
		$geojson = "";
		for($m = 0; $m < @msoas; $m++){
			$str = getGeoJSON(
				'code'=>$msoas[$m],
				'type'=>'MSOA11CD',
				'url'=>$conf->{'geojson'}{$type}{'url'},
				'dir'=>$basedir.$conf->{'geojson'}{'MSOA'}{'dir'}
			);
			$str =~ s/[\n\r]//g;
			$str =~ s/(,"msoa11nm":"[^\"]*")/$1,"msoa11hclnm":"$msoa{$msoas[$m]}{'name'}"/g;
			$str =~ s/(,"msoa11nmw":"[^\"]*")//;
			$geojson .= ($geojson ? ",\n":"").$str;
		}
		if($geojson){
			print "\tSaving GeoJSON to $gfile\n";
			open(GEO,">",$gfile);
			print GEO "{\n";
			print GEO "\"type\": \"FeatureCollection\",\n";
			print GEO "\"features\":[\n";
			print GEO $geojson."\n";
			print GEO "]\n";
			print GEO "}\n";
			close(GEO);
		}else{
			print "\tWARNING: No GeoJSON for $l ($gfile)\n";
		}
	}
}


print "You should now run \"perl buildScores.pl\" to update the scores.\n";


# Create GeoJSON
#{
#"type": "FeatureCollection",
#"features":[
#{"type":"Feature","properties":{"msoa11cd":"E02002483","msoa11nm":"Hartlepool 001","msoa11hclnm":"Clavering","msoa11nmw":"Hartlepool 001" }, "geometry":{"type":"MultiPolygon","coordinates":[[[[-1.24578,54.72228],[-1.2476,54.7224],[-1.24875,54.72072],[-1.25135,54.71975],[-1.25185,54.71961],[-1.25493,54.71877],[-1.25982,54.71694],[-1.26406,54.7172],[-1.26229,54.71437],[-1.26075,54.71438],[-1.25744,54.71484],[-1.25673,54.71395],[-1.25583,54.71277],[-1.25666,54.71241],[-1.25651,54.71211],[-1.25608,54.71218],[-1.25501,54.71009],[-1.25472,54.70952],[-1.25439,54.70884],[-1.25303,54.70582],[-1.25053,54.706],[-1.24869,54.70552],[-1.2477,54.70422],[-1.24736,54.70366],[-1.2456,54.70369],[-1.24424,54.70372],[-1.24412,54.70331],[-1.24344,54.70336],[-1.24251,54.70212],[-1.24065,54.70225],[-1.24035,54.7015],[-1.23891,54.70175],[-1.23629,54.70221],[-1.23395,54.70262],[-1.23219,54.70292],[-1.23324,54.70379],[-1.23789,54.70783],[-1.23502,54.70817],[-1.2341,54.70827],[-1.23402,54.70852],[-1.22859,54.70903],[-1.23008,54.70926],[-1.23104,54.70983],[-1.23039,54.71034],[-1.23284,54.71075],[-1.23291,54.71154],[-1.23284,54.71166],[-1.23232,54.71264],[-1.23631,54.71388],[-1.23876,54.71477],[-1.23781,54.71541],[-1.23712,54.71523],[-1.23484,54.71591],[-1.23145,54.71769],[-1.23688,54.72022],[-1.23926,54.72138],[-1.24283,54.72225],[-1.24401,54.72157],[-1.24578,54.72228 ]]],[[[-1.24196,54.72245],[-1.24192,54.72271],[-1.24251,54.72242],[-1.24196,54.72245 ]]]]} },
#{"type":"Feature","properties":{"msoa11cd":"E02002484","msoa11nm":"Hartlepool 002","msoa11hclnm":"Headland & West View","msoa11nmw":"Hartlepool 002" }, "geometry":{"type":"MultiPolygon","coordinates":[[[[-1.22728,54.7156],[-1.23145,54.71769],[-1.23484,54.71591],[-1.23712,54.71523],[-1.23781,54.71541],[-1.23876,54.71477],[-1.23631,54.71388],[-1.23232,54.71264],[-1.23284,54.71166],[-1.23291,54.71154],[-1.23284,54.71075],[-1.23039,54.71034],[-1.23104,54.70983],[-1.23008,54.70926],[-1.22859,54.70903],[-1.23402,54.70852],[-1.2341,54.70827],[-1.23502,54.70817],[-1.23789,54.70783],[-1.23324,54.70379],[-1.23219,54.70292],[-1.22907,54.70017],[-1.2287,54.69996],[-1.22549,54.69946],[-1.22158,54.69909],[-1.22093,54.69902],[-1.21228,54.69792],[-1.21244,54.69738],[-1.21218,54.69486],[-1.21213,54.69437],[-1.21184,54.69177],[-1.20959,54.69222],[-1.20874,54.69232],[-1.20587,54.69299],[-1.20258,54.69322],[-1.20055,54.69332],[-1.20026,54.69333],[-1.2001,54.69333],[-1.19635,54.69337],[-1.19547,54.69449],[-1.19217,54.69358],[-1.18937,54.69425],[-1.18749,54.6939],[-1.19069,54.6946],[-1.19047,54.69604],[-1.19109,54.69602],[-1.19273,54.69733],[-1.19427,54.69766],[-1.19373,54.69666],[-1.19471,54.69779],[-1.19502,54.69769],[-1.1958,54.69842],[-1.1962,54.69834],[-1.19631,54.69855],[-1.19324,54.70017],[-1.19319,54.7002],[-1.19265,54.70041],[-1.19234,54.70029],[-1.19213,54.70016],[-1.19222,54.7001],[-1.19052,54.69918],[-1.19049,54.69921],[-1.19028,54.69921],[-1.19006,54.69909],[-1.18946,54.69876],[-1.18955,54.6987],[-1.18945,54.69865],[-1.18806,54.69799],[-1.1858,54.69752],[-1.18649,54.6964],[-1.18838,54.69673],[-1.18886,54.69682],[-1.19008,54.69699],[-1.18957,54.6963],[-1.18948,54.69622],[-1.18924,54.69613],[-1.18692,54.69515],[-1.1839,54.69473],[-1.18309,54.69388],[-1.18406,54.69362],[-1.1842,54.69359],[-1.18479,54.69326],[-1.1829,54.69365],[-1.18164,54.69319],[-1.17848,54.69398],[-1.177,54.69464],[-1.17383,54.69187],[-1.17704,54.69489],[-1.17523,54.69658],[-1.17772,54.69924],[-1.17784,54.69923],[-1.17796,54.69922],[-1.18314,54.70108],[-1.18764,54.70191],[-1.19106,54.70286],[-1.19441,54.70416],[-1.20246,54.70617],[-1.20995,54.70891],[-1.21422,54.71079],[-1.2177,54.71153],[-1.21823,54.71198],[-1.22396,54.71451],[-1.22728,54.7156 ]]]]} },
#{"type":"Feature","properties":{"msoa11cd":"E02002485","msoa11nm":"Hartlepool 003","msoa11hclnm":"Jesmond","msoa11nmw":"Hartlepool 003" }, "geometry":{"type":"MultiPolygon","coordinates":[[[[-1.23219,54.70292],[-1.23395,54.70262],[-1.23629,54.70221],[-1.23891,54.70175],[-1.23835,54.70063],[-1.24116,54.70113],[-1.24118,54.7009],[-1.24174,54.7009],[-1.24081,54.6994],[-1.24146,54.69882],[-1.24339,54.69784],[-1.24501,54.69698],[-1.24506,54.69658],[-1.24574,54.69647],[-1.24523,54.69495],[-1.2448,54.69492],[-1.24431,54.69408],[-1.24355,54.69437],[-1.244,54.69464],[-1.24373,54.6948],[-1.24193,54.69407],[-1.2439,54.69302],[-1.24118,54.69158],[-1.23869,54.69135],[-1.23859,54.69195],[-1.23842,54.69353],[-1.23786,54.69423],[-1.23657,54.69419],[-1.23605,54.69349],[-1.23515,54.6941],[-1.23358,54.69407],[-1.2336,54.6938],[-1.23116,54.69389],[-1.22958,54.69527],[-1.22777,54.69535],[-1.22754,54.69446],[-1.22709,54.69275],[-1.22664,54.69106],[-1.22657,54.69015],[-1.22604,54.69015],[-1.22373,54.69028],[-1.22111,54.69039],[-1.219,54.69055],[-1.21817,54.69064],[-1.21198,54.69174],[-1.21184,54.69177],[-1.21213,54.69437],[-1.21218,54.69486],[-1.21244,54.69738],[-1.21228,54.69792],[-1.22093,54.69902],[-1.22158,54.69909],[-1.22549,54.69946],[-1.2287,54.69996],[-1.22907,54.70017],[-1.23219,54.70292 ]]]]} },
#{"type":"Feature","properties":{"msoa11cd":"E02002487","msoa11nm":"Hartlepool 005","msoa11hclnm":"Harbour & Victoria","msoa11nmw":"Hartlepool 005" }, "geometry":{"type":"MultiPolygon","coordinates":[[[[-1.19565,54.69257],[-1.19217,54.69358],[-1.19547,54.69449],[-1.19635,54.69337],[-1.2001,54.69333],[-1.20026,54.69333],[-1.20055,54.69332],[-1.20258,54.69322],[-1.20587,54.69299],[-1.20874,54.69232],[-1.20959,54.69222],[-1.21184,54.69177],[-1.21198,54.69174],[-1.21817,54.69064],[-1.219,54.69055],[-1.22111,54.69039],[-1.22373,54.69028],[-1.22604,54.69015],[-1.22657,54.69015],[-1.22676,54.69015],[-1.23031,54.69039],[-1.2303,54.68942],[-1.23036,54.68749],[-1.23044,54.68691],[-1.2288,54.68682],[-1.22698,54.68673],[-1.22543,54.68669],[-1.22443,54.68665],[-1.22321,54.68659],[-1.22161,54.68652],[-1.22082,54.68648],[-1.21963,54.6864],[-1.21988,54.68555],[-1.21803,54.68539],[-1.21305,54.68538],[-1.21153,54.6855],[-1.21134,54.6872],[-1.21052,54.68729],[-1.20999,54.68705],[-1.20822,54.6868],[-1.20377,54.68743],[-1.20059,54.68679],[-1.19937,54.68577],[-1.19739,54.68596],[-1.19675,54.68608],[-1.19609,54.6863],[-1.19415,54.6878],[-1.19431,54.68833],[-1.1946,54.68784],[-1.1961,54.68637],[-1.19812,54.68604],[-1.19866,54.68625],[-1.19868,54.68711],[-1.19717,54.68821],[-1.19545,54.68905],[-1.19659,54.68868],[-1.19795,54.68904],[-1.19785,54.68981],[-1.19841,54.6901],[-1.19783,54.69184],[-1.19646,54.69211],[-1.19631,54.69199],[-1.19616,54.69142],[-1.19479,54.69053],[-1.19482,54.68937],[-1.19439,54.69025],[-1.19616,54.69186],[-1.19565,54.69257 ]]]]} },
#]
#}